#!/bin/bash
#
# Managed by Chef - local modifications will be overwritten
#

# Set the location of the pid file
if [ -z "$CATALINA_PID" ] ; then
    if [ -n "$CATALINA_BASE" ] ; then
        CATALINA_PID="$CATALINA_BASE"/work/catalina.pid
    elif [ -n "$CATALINA_HOME" ] ; then
        CATALINA_PID="$CATALINA_HOME"/work/catalina.pid
    fi
fi
export CATALINA_PID

PRGDIR=`dirname "$0"`
if [ -z "$CATALINA_BASE" ]; then
  if [ -z "$CATALINA_HOME" ]; then
    LOGBASE=$PRGDIR
    LOGTAIL=..
  else
    LOGBASE=$CATALINA_HOME
    LOGTAIL=.
  fi
else
  LOGBASE=$CATALINA_BASE
  LOGTAIL=.
fi

PUSHED_DIR=`pwd`
cd $LOGBASE
cd $LOGTAIL
LOGBASEABS=`pwd`
cd $PUSHED_DIR

# JVM Memory Settings
CATALINA_OPTS="-Xms<%= @jvm_minimum_memory %> -Xmx<%= @jvm_maximum_memory %> ${CATALINA_OPTS}"

# G1GC Settings
CATALINA_OPTS="-XX:+UseG1GC ${CATALINA_OPTS}"
CATALINA_OPTS="-XX:G1ReservePercent=20 ${CATALINA_OPTS}"

# GC Logging
CATALINA_OPTS="-Xlog:gc*:file=$LOGBASEABS/logs/gc-%t.log:time,level,tags:filecount=5,filesize=2M ${CATALINA_OPTS}"

# Confluence specific settings
CATALINA_OPTS="-Djava.awt.headless=true ${CATALINA_OPTS}"
CATALINA_OPTS="-Datlassian.plugins.enable.wait=300 ${CATALINA_OPTS}"
CATALINA_OPTS="-Dorg.apache.tomcat.websocket.DEFAULT_BUFFER_SIZE=32768 ${CATALINA_OPTS}"
CATALINA_OPTS="-Dconfluence.home=<%= @home_path %> ${CATALINA_OPTS}"

<% if @jvm_support_recommended_args && !@jvm_support_recommended_args.empty? -%>
# Support recommended args
CATALINA_OPTS="<%= @jvm_support_recommended_args %> ${CATALINA_OPTS}"
<% end -%>

<% if @catalina_opts && !@catalina_opts.empty? -%>
# Additional CATALINA_OPTS
CATALINA_OPTS="<%= @catalina_opts %> ${CATALINA_OPTS}"
<% end -%>

export CATALINA_OPTS
